# Spotify Premium 解锁 [优化版]
# 原作者: @daozen (https://github.com/daozen/rules)
# 优化: 去除重复规则 + header操作改用原生rewrite(省去JS引擎启动开销)
# 功能: 1.去除播放广告 2.歌手/专辑列表正常展示 3.去除随机播放
# 注意: 部分解锁premium,音质不能设置为超高(建议登录后再打开脚本,重启app等待脚本生效)

hostname = spclient.wg.spotify.com, *spclient.spotify.com

# ========== 优化说明 ==========
# 原版6条规则中，spclient.wg.spotify.com 和 gae2-spclient.spotify.com 各写了一遍
# 但正则 .*-spclient\.spotify\.com 已覆盖 gae2-spclient.spotify.com
# 所以3条重复规则可以直接删除，减少正则匹配开销
#
# 原版 spotify-qx-header.js 仅删除 If-None-Match 请求头(3行JS)
# 改用QX原生 request-header 实现，完全不需要启动JS引擎

# > [优化] 删除If-None-Match请求头 - 原生rewrite替代JS脚本，零JS开销
^https:\/\/(spclient\.wg\.spotify\.com|.*-spclient\.spotify\.com(:443)?)\/user-customization-service\/v1\/customize$ url request-header (\r\n)If-None-Match:[^\r\n]*(\r\n) request-header $1$2

# > Protobuf解码+注入Premium属性 - 必须用JS(二进制protobuf无法用jq处理)
^https:\/\/(spclient\.wg\.spotify\.com|.*-spclient\.spotify\.com(:443)?)\/(bootstrap\/v1\/bootstrap|user-customization-service\/v1\/customize)$ url script-response-body https://raw.githubusercontent.com/daozen/rules/master/js/spotify-proto.js

# > [优化] 将platform=iphone改为ipad - 原生302重定向替代JS脚本
# 注意: 此处仍用JS是因为需要动态判断URL中是否包含platform=iphone再做替换
# 原生rewrite无法做条件判断，但该脚本极轻(10行)，开销可忽略
^https:\/\/(spclient\.wg\.spotify\.com|.*-spclient\.spotify\.com(:443)?)\/(artistview\/v1\/artist|album-entity-view\/v2\/album)\/ url script-request-header https://raw.githubusercontent.com/daozen/rules/master/js/spotify-json.js
